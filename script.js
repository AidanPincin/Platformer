const data = window.localStorage
const canvas = document.querySelector('canvas')
const ctx = canvas.getContext('2d')
let time = 0
let fps = 60
var classes = {}
class Obj{
    constructor(x,y,width,height,color){
        this.x = x
        this.y = y
        this.width = width
        this.color = color
        this.height = height
    }
    draw(){
        ctx.fillStyle = this.color
        ctx.fillRect(this.x,this.y,this.width,this.height)
    }
}
class Player{
    constructor(){
        this.keys = ['w','a','d','ArrowUp','ArrowRight','ArrowLeft']
        this.actions = ['up','left','right','up','right','left']
        this.speed = 5
        this.x = 400
        this.y = 760
        this.time = 0
        this.speedY = 0
        this.on = undefined
        this.gravity = 2
        this.size = 20
        this.jump = false
        this.cooldown = 0
    }
    draw(){
        if(this.cooldown>0){
            this.cooldown -= 1
        }
        this.y += this.speedY
        if(this.right == true){
            this.x += this.speed
        }
        if(this.left == true){
            this.x -= this.speed
        }
        this.detectCollision()
        if(this.up == true && this.jump == false){
            this.speedY = -10
            this.time = 1/60
            this.jump = true
        }
        if(this.time != 0){
            this.time += 1/60
            this.speedY += this.time*this.gravity
        }
        if(this.y>=780-this.size){
            this.speedY = -0.01
            this.time = 0
            this.jump = false
            this.y = 780-this.size
        }
        if(this.x<0){
            this.x=0
        }
        if(this.x>1400-this.size){
            this.x=1380
        }
        ctx.fillStyle = '#00ff00'
        ctx.fillRect(this.x,this.y,this.size,this.size)
        ctx.fillStyle = '#000000'
        ctx.beginPath()
        ctx.arc(this.x+5,this.y+7.5,3.25,0,Math.PI*2,false)
        ctx.arc(this.x+15,this.y+7.5,3.25,0,Math.PI*2,false)
        ctx.fill()
        ctx.beginPath()
        ctx.moveTo(this.x,this.y+7.5)
        ctx.lineTo(this.x+20,this.y+7.5)
        ctx.lineWidth = 2
        ctx.strokeStyle = '#000000'
        ctx.stroke()
        ctx.beginPath()
        ctx.moveTo(this.x+5,this.y+15)
        ctx.lineTo(this.x+15,this.y+15)
        ctx.strokeStyle = '#7d0000'
        ctx.stroke()
    }
    keyPress(e,bln){
        this[this.actions[this.keys.findIndex(k => k == e.key)]] = bln
    }
    detectCollision(){
        let onTop = false
        for (let i=0; i<objects.length; i++){
            const {x:x, y:y, width:w, height:h, color:c} = objects[i]
            if(this.x<x+w && this.x+this.size>x && this.y<y+h && this.y+this.size>y){
                if(c == '#007d00'){
                    const x_dist = ((this.x+this.size/2)-(x+w/2))/(w/(w+h))
                    const y_dist = ((this.y+this.size/2)-(y+h/2))/(h/(w+h))-this.speedY
                    if(Math.abs(x_dist)>Math.abs(y_dist)){
                        if(x_dist<0){
                            this.x = x-this.size
                        }
                        else{
                            this.x = x+w
                        }
                    }
                    else{
                        if(y_dist<0){
                            this.y = y-this.size
                            onTop = true
                        }
                        else{
                            this.y = y+h
                            this.speedY = 0
                        }
                    }
                }
                if(c == '#ff0000'){
                    player = new Player()
                }
                if(c == '#0000ff'){
                    lvl += 1
                    data.setItem('lvl',lvl)
                    player = new Player()
                    objects = breakDown(lvls[lvl])
                    if(lvl == 7){
                        let seconds = recordTime/60
                        const minutes = Math.floor(seconds/60)
                        seconds -= minutes*60
                        alert('You beat the game!\nYour time -- '+minutes+' min. & '+seconds.toFixed(2)+' sec.')
                    }
                }
                if(c == '#000000'){
                    this.y = y-20
                    this.speedY = objects[i].speed
                    this.time = 1/60
                    this.jump = false
                }
                if ((c == '#763568' || c == 'orange') && this.cooldown == 0){
                    this.x = objects[i].portal.x
                    this.y = objects[i].portal.y
                    this.cooldown = 300
                }
            }
        }
        if(onTop==true){
            this.time = 0
            this.speedY = 0
            this.jump = false
        }
        else{
            if(this.time==0 && this.y<780-this.size){
                this.time += 1/60
            }
        }
    }
}
let lvl = 1
//JSON.parse(data.getItem('lvl'))
if(lvl == null){
    lvl = 1
    data.setItem('lvl',1)
}
classes.g = class extends Obj{
    constructor(x,y,width=20,height=20,color='#007d00'){
        super(x,y,width,height,color)
    }
}
classes.f = class extends Obj{
    constructor(x,y,width=20,height=20,color='#ff0000'){
        super(x,y,width,height,color)
    }
}
classes.b = class extends Obj{
    constructor(x,y,width=20,height=20,color='#0000ff'){
        super(x,y,width,height,color)
    }
}
classes.t = class extends Obj{
    constructor(x,y,width=20,height=20,color='#000000'){
        super(x,y,width,height,color)
        this.speed = -15
    }
}
classes.p = class extends Obj{
    constructor(x,y,width=20,height=20,color='#763568'){
        super(x,y,width,height,color)
    }
}
classes.o = class extends Obj{
    constructor(x,y,width=20,height=20,color='orange'){
        super(x,y,width,height,color)
    }
}
function breakDown(string){
    const objs = []
    for (let i=0; i<string.length; i++){
        let cols = i
        let rows = 0
        while (cols>69){
            cols -= 70
            rows += 1
        }
        if(string.slice(i,i+1) != '_'){
            objs.push(new classes[string.slice(i,i+1)](cols*20,rows*20))
        }
    }
    return objs
}
const lvls = {
    1:
    '_____________________________________________________________________b_____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ggg_____ggg___g______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ggg__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ggg________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ggg__________________________________________________________________________________________________________________________________________________________________________________________________________ggg____________________________________________________________________________________________________________________________________ggg________________________________________________________________________________________________________________________________________________________________________________________________________gggg______________________________________________________________________________________________________________________________________________________________________________________________________gggg______________________________________________________________________________________________________________________________________________________________________________________________________gggg_____________________________________________________________________________________________________________________________________________________________________________________________________gggg__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________'
    ,
    2:
    '_______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________b_________________________________________________________________ggggggggggg_________________________________________________________________________________________________________________________________ggggggggggg__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________' 
    ,
    3:
    '__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________b_____________________________________________________________________________________________g_ffff____ff_______ff_______ff_______ff_______________________________g_________ff_______ff_______ff_______ff_______________________________g_________gg_______gg_______gg_______gg_______________________________g_ggggggggggggggggggggggggggggggggggggggggggggg_______________________g_g___________________________________________________________________g_g___________________________________________________________________g_g___________________________________________________________________g_g___________________________________________________________________g__g___________________________________________________________________g__g___________________________________________________________________g__g___________________________________________________________________g______________________________________________________________________gg______________________________________________________________________ggffff_____gg___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________gg____________________________________________________________________________________________________________________________________________________________________________________________________________gg___________________________________________________________________________________________________________________________________________________________________________________________________________gg___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________gggffggg______________________________________________________________________________________________________________________________________________________________________________________________________'
    ,
    4:
    '__________________________________________________________________________________________________________________________________________________g_____________________________________________________________________g_____________________ggg_____________________________________________g_________________________________________________________________b___g_____________________________________________________________________g____________ggg______________________________________________________g_____________________________________________________________________g____________________________gggggggggggg_____________________________g_________________________________________________________________g___g____________________________gggggggggggg_____________________________g_________________________________________________________________g___g_______ggg___________________________________________________________g_____________________________________________________________________g_____________________________________________________________________g_____________________________________________________________________g____________________________gggggggggggg_____________________________g_________________________________________________________________g___g____________________________gggggggggggg_____________________________ggg___________________________________________________________________gg_______________________________________________________________________ggg__________________________________________________________ggggggggg__________________________gggggggggggg______________________________________________________________________________________________________________________________________________________________________________________________________gggggggggggg________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________gggggggggggg________________________________________________________________________________________________________________________________gggggggggggg_____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________'
    ,
    5:
    '____________________________b__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________f____________________________________________________________________ggg_____t______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ggg_________________________________________________________________________________________________________________________________________________t________________________________________________________g____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________f____________________________________________________________________gf_____________________________________________________________________f_____________________________________________________________________f_____________________________________________________________________f____________________________________________________________________'
    ,
    6:
    '________________________________b____________________________________________________________________ggg____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________t____________________________________________________________________ggg________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________t_____________________________________'
    ,
    7:
    ''
    ,
    8:
    ''
    ,
    9:
    ''
    ,
    10:
    ''
    ,
}
let recordTime = 0
let objects = breakDown(lvls[lvl])
let player = new Player()
function mainLoop(){
    time += 1
    recordTime += 1
    ctx.fillStyle = '#ffffff'
    ctx.fillRect(0,0,1400,800)
    ctx.fillStyle = '#007d00'
    ctx.fillRect(0,780,1400,20)
    ctx.fillStyle = '#000000'
    ctx.font = '24px Arial'
    ctx.fillText('FPS -- '+fps,5,30)
    ctx.fillText('Level -- '+lvl,5,60)
    let height = Math.abs(Math.floor((player.y+21)/20-40))
    ctx.fillText(height,5,90)
    for (let i=0; i<objects.length; i++){
        objects[i].draw()
    }
    player.draw()
    requestAnimationFrame(mainLoop)
}
mainLoop()
setInterval(() => {
    fps = time
    time = 0
},1000)
window.addEventListener('keydown',function(e){player.keyPress(e,true)})
window.addEventListener('keyup',function(e){player.keyPress(e,false)})