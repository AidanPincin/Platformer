const data = window.localStorage
const canvas = document.querySelector('canvas')
const ctx = canvas.getContext('2d')
let time = 0
let fps = 60
var classes = {}
class Obj{
    constructor(x,y,width,height,color){
        this.x = x
        this.y = y
        this.width = width
        this.color = color
        this.height = height
    }
    draw(){
        ctx.fillStyle = this.color
        ctx.fillRect(this.x,this.y,this.width,this.height)
    }
}
class Player{
    constructor(x=400,y=760){
        this.keys = ['w','a','d','ArrowUp','ArrowRight','ArrowLeft',' ']
        this.actions = ['up','left','right','up','right','left','up']
        this.speed = 5
        this.x = x
        this.y = y
        this.time = 0
        this.speedY = 0
        this.on = undefined
        this.gravity = 2
        this.size = 20
        this.jump = false
        this.r = 1
        this.cooldown = 0
    }
    draw(){
        if (this.cooldown>0){
            this.cooldown -= 1
        }
        this.y += this.speedY
        if(this.right == true){
            this.x += this.speed
        }
        if(this.left == true){
            this.x -= this.speed
        }
        this.detectCollision()
        if(this.up == true && this.jump == false){
            this.speedY = -10*this.r
            this.time = 1/60
            this.jump = true
        }
        if(this.time != 0){
            this.time += 1/60
            this.speedY += this.time*this.gravity*this.r
        }
        if(this.y>=780-this.size){
            if(this.r == 1){
                this.speedY = 0
                this.time = 0
                this.jump = false
                this.y = 779.999-this.size
            }
            else{
                this.speedY = 0
                this.y = 779.999-this.size
            }
        }
        if(this.x<0){
            this.x=0
        }
        if(this.x>1400-this.size){
            this.x=1380
        }
        ctx.fillStyle = '#00ff00'
        ctx.fillRect(this.x,this.y,this.size,this.size)
        ctx.fillStyle = '#000000'
        ctx.beginPath()
        ctx.arc(this.x+5,this.y+7.5,3.25,0,Math.PI*2,false)
        ctx.arc(this.x+15,this.y+7.5,3.25,0,Math.PI*2,false)
        ctx.fill()
        ctx.beginPath()
        ctx.moveTo(this.x,this.y+7.5)
        ctx.lineTo(this.x+20,this.y+7.5)
        ctx.lineWidth = 2
        ctx.strokeStyle = '#000000'
        ctx.stroke()
        ctx.beginPath()
        ctx.moveTo(this.x+5,this.y+15)
        ctx.lineTo(this.x+15,this.y+15)
        ctx.strokeStyle = '#7d0000'
        ctx.stroke()
    }
    keyPress(e,bln){
        this[this.actions[this.keys.findIndex(k => k == e.key)]] = bln
    }
    detectCollision(){
        let onTop = false
        for (let i=0; i<objects.length; i++){
            const {x:x, y:y, width:w, height:h, color:c} = objects[i]
            if(this.x<x+w && this.x+this.size>x && this.y-Math.abs(this.speedY)<y+h && this.y+this.size+Math.abs(this.speedY)>y){
                if(c == '#007d00'){
                    const x_dist = ((this.x+this.size/2)-(x+w/2))/(w/(w+h))
                    const y_dist = ((this.y+this.size/2)-(y+h/2))/(h/(w+h))-this.speedY
                    if(Math.abs(x_dist)>Math.abs(y_dist)){
                        if(x_dist<0){
                            this.x = x-this.size
                        }
                        else{
                            this.x = x+w
                        }
                    }
                    else{
                        if(y_dist<0){
                            this.y = y-this.size
                            if(this.r == 1){
                                onTop = true
                            }
                        }
                        else{
                            this.y = y+h
                            this.speedY = 0
                            if(this.r == -1){
                                onTop = true
                            }
                        }
                    }
                }
                if(c == '#ff0000'){
                    player = new Player()
                }
                if(c == '#0000ff'){
                    lvl += 1
                    data.setItem('lvl',lvl)
                    player = new Player()
                    objects = breakDown(lvls[lvl])
                    if(lvl == 11){
                        let seconds = recordTime/60
                        const minutes = Math.floor(seconds/60)
                        seconds -= minutes*60
                        alert('You beat the game!\nYour time -- '+minutes+' min. & '+seconds.toFixed(2)+' sec.')
                    }
                }
                if(c == '#000000'){
                    this.y = y-20*this.r
                    this.speedY = objects[i].speed*this.r
                    this.time = 1/60
                    this.jump = false
                }
                if(c == '#add8e6' && this.cooldown == 0){
                    this.r *= -1
                    this.cooldown = 30
                }
            }
        }
        if(onTop==true){
            this.time = 0
            this.speedY = 0
            this.jump = false
        }
        else{
            if(this.time==0 && this.y<780-this.size){
                this.time += 1/60
            }
        }
    }
}
let lvl = 1
//JSON.parse(data.getItem('lvl'))
if(lvl == null){
    lvl = 1
    data.setItem('lvl',1)
}
classes.g = class extends Obj{
    constructor(x,y,width=20,height=20,color='#007d00'){
        super(x,y,width,height,color)
    }
}
classes.f = class extends Obj{
    constructor(x,y,width=20,height=20,color='#ff0000'){
        super(x,y,width,height,color)
    }
}
classes.b = class extends Obj{
    constructor(x,y,width=20,height=20,color='#0000ff'){
        super(x,y,width,height,color)
    }
}
classes.t = class extends Obj{
    constructor(x,y,width=20,height=20,color='#000000'){
        super(x,y,width,height,color)
        this.speed = -15
    }
}
classes.r = class extends Obj{
    constructor(x,y,width=20,height=20,color='#add8e6'){
        super(x,y,width,height,color)
    }
}
function breakDown(string){
    const objs = []
    for (let i=0; i<string.length; i++){
        let cols = i
        let rows = 0
        while (cols>69){
            cols -= 70
            rows += 1
        }
        if(string.slice(i,i+1) != '_'){
            objs.push(new classes[string.slice(i,i+1)](cols*20,rows*20))
        }
    }
    return objs
}
const lvls = {
    1:
    '_____________________________________________________________________b_____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ggg_____ggg___g______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ggg__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ggg________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ggg__________________________________________________________________________________________________________________________________________________________________________________________________________ggg____________________________________________________________________________________________________________________________________ggg________________________________________________________________________________________________________________________________________________________________________________________________________gggg______________________________________________________________________________________________________________________________________________________________________________________________________gggg______________________________________________________________________________________________________________________________________________________________________________________________________gggg_____________________________________________________________________________________________________________________________________________________________________________________________________gggg__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________'
    ,
    2:
    '_______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________b_________________________________________________________________ggggggggggg_________________________________________________________________________________________________________________________________ggggggggggg__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________'
    ,
    3:
    '__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________b_____________________________________________________________________________________________g_ffff____ff_______ff_______ff_______ff_______________________________g_________ff_______ff_______ff_______ff_______________________________g_________gg_______gg_______gg_______gg_______________________________g_ggggggggggggggggggggggggggggggggggggggggggggg_______________________g_g___________________________________________________________________g_g___________________________________________________________________g_g___________________________________________________________________g_g___________________________________________________________________g__g___________________________________________________________________g__g___________________________________________________________________g__g___________________________________________________________________g______________________________________________________________________gg______________________________________________________________________ggffff_____gg___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________gg____________________________________________________________________________________________________________________________________________________________________________________________________________gg___________________________________________________________________________________________________________________________________________________________________________________________________________gg___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________gggffggg______________________________________________________________________________________________________________________________________________________________________________________________________'
    ,
    4:
    '__________________________________________________________________________________________________________________________________________________g_____________________________________________________________________g_____________________ggg_____________________________________________g_________________________________________________________________b___g_____________________________________________________________________g____________ggg______________________________________________________g_____________________________________________________________________g____________________________gggggggggggg_____________________________g_________________________________________________________________g___g____________________________gggggggggggg_____________________________g_________________________________________________________________g___g_______ggg___________________________________________________________g_____________________________________________________________________g_____________________________________________________________________g_____________________________________________________________________g____________________________gggggggggggg_____________________________g_________________________________________________________________g___g____________________________gggggggggggg_____________________________ggg___________________________________________________________________gg_______________________________________________________________________ggg__________________________________________________________ggggggggg__________________________gggggggggggg______________________________________________________________________________________________________________________________________________________________________________________________________gggggggggggg________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________gggggggggggg________________________________________________________________________________________________________________________________gggggggggggg_____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________'
    ,
    5:
    '________________________________b____________________________________________________________________ggg____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________t____________________________________________________________________ggg________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________t_____________________________________'
    ,
    6:
    '____________________________b__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________f____________________________________________________________________ggg_____t______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ggg_________________________________________________________________________________________________________________________________________________t________________________________________________________g____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________f____________________________________________________________________gf_____________________________________________________________________f_____________________________________________________________________f_____________________________________________________________________f____________________________________________________________________'
    ,
    7:
    'ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________gggggggg______________________________________________________________r______g_____________________________________________________________________g_____________________________________________________________________g_____________________________________________________________________g___________________________________________b_________________________g___________________________________________gggggggggggggggggggfff____g_______________________________________________________________f_____g_______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________r___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________t__________________________________'
    ,
    8:
    '_______________________ggg________gg_________________ggggfffffffffffff_______________________ggg________gg_____ttt_________gggg____b_______________________________ggg________gg_________________gggg____________________________________ggg________gg_________________gggg____________________________________ggg________gg_________________gggg____________________________________ggg________gg_________________gggg____________________________________ggg________gg_________________gggg____________________________________ggg________gg_________________gggg____________________________________ggg________gg_________________gggg____________________________________ggg________gg_________________gggg____________________________________ggg________gg_________________gggg____________________________________ggg________gg_________________gggg__ggggggggggg_______________________ggg________gg_________________gggg____________________________________ggg________gg_________________gggg____________________________________ggg________gg_________________gggg____________________________________ggg________gg_________________gggg____________________________________ggg________gg_________________gggggggggggggfgg________________________ggg______________________________g____________________________________ggg______________________________g____________________________________ggg______________________________g____________________________________ggg______________________________g___f__r_________________f___________ggg______________________________g_gggggggggggg___________f___________ggg______________________________g________________________f___________ggg____________________________r_g________________________f___________ggg______________________________g________________________f___________ggg______________________________ggggffgggfggg________ggggfggg_____r__ggg______________________________ggggggggggggg________g__fff_g_________________________________________g____________________g_fffffg_________________________________________g____________________g_fffffg______________________________________________________________g_fffffggg____________________________________ggggggggggfgggggg_______gfffffff_g____________________________________ggg______________ggg____gfffffff_g____________________________________ggg________________g____gffffffffg____________________________________ggg________________g____gggggggggg____________________________________ggg________________g__________________________________________________ggg________________g__________________________________________________ggg________________g__________________________________________________ggg________________g__________________________________________________ggg______________'
    ,
    9:
    '____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrfrrrrrrrrrrfrrrrrrrrrrffrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrfrrrrrrrrrrfrrrrrrrrrffrrrrrrrrrrrffrrrrb'
    ,
    10:
    '_____________ttt____________ff______ff______ff______ff___________________________________________ffff____ffff____ffff____ffff__________________________________________fggf____fggf____fggf____fggf__________________________________________f__f____f__f____f__f____f__f__________________________________________ffff____ffff____ffff____ffff__________________________________________gggg____gggg____gggg____gggg_______tttttt___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________fgggggg_gf____________________________________________________________fgffffg_gf____________________________________r_g____________fff____r_fg_fffg_gf______________________________________g____________fgf______fg_fffg_gfffffffffffffffffffffffff______________g____________fgffff___fg_ff_g_gggggggggggggggggggggggggg______________g____________fggggg___gg_ff_g__________________________g______________g____________f____g___g__f__g__________________________g______________g_________r__f____g___g__f__gggg_ggggg_gggg__ggg__gggg_g___gggggg_____g____________f____g___g__f_ffffffffffffffffffffffffffg_g______________g____________f____g___g____fgggggggggggggggggggggggggg_g______________g____________f____g___g____fg__________________________g______________g____________f____g___g___ffg__g_______________________g______________g___________fff___g___g___ffg__g_______________________g______________g___________fff___g___g___ffg_gg_______________________g___gggggg_____g___________fff___g___g___ffg__g_r_____________________g______________g__________fffffffg___g__fffg__ggggfffggggfffggggfffgggg___gggggggg___g__________fffggggg___g__fffg__ggggggggggggggggggggggggg___g______b___g________fffffg_______g__fffgg_gr__ggg____ggg____ggg_______g__________g________fffffg_____r_g__fffg__g___fff____fff____fff_______g__________g__ttt__ffffffg_ggggggg__fffg__g___fff____fff____fff___ggggg__________g______fffffffg_______g_ffffg__g___fff____fff____fff___g______________gfffffffffffffg_______g_ffffg__g_______________________g_______g______gggggfggggfgggg_______ggggggg__g_______________________g_____________________________________________g_______________________g_____________________________________________g___________________________________'
    ,
    11:
    ''
    ,
}
let recordTime = 0
let objects = breakDown(lvls[lvl])
let player = new Player()
function mainLoop(){
    time += 1
    recordTime += 1
    ctx.fillStyle = '#ffffff'
    ctx.fillRect(0,0,1400,800)
    for (let i=0; i<objects.length; i++){
        objects[i].draw()
    }
    if(player.y<=-10000){
        player = new Player()
    }
    ctx.fillStyle = '#007d00'
    ctx.fillRect(0,780,1400,20)
    ctx.fillStyle = '#000000'
    ctx.font = '24px Arial'
    ctx.fillText('FPS -- '+fps,5,30)
    ctx.fillText('Level -- '+lvl,5,60)
    let height = Math.abs(Math.floor((player.y+21)/20-40))
    ctx.fillText(height,5,90)
    player.draw()
    requestAnimationFrame(mainLoop)
}
mainLoop()
setInterval(() => {
    fps = time
    time = 0
},1000)
window.addEventListener('keydown',function(e){player.keyPress(e,true)})
window.addEventListener('keyup',function(e){player.keyPress(e,false)})
